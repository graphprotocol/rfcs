<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>PLAN-0003: Remove JSONB Storage - Graph Protocol RFCs and Engineering Plans</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../assets/mermaid.css">
        
        <link rel="stylesheet" href="../assets/custom.css">
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../rfcs/index.html"><strong aria-hidden="true">2.</strong> RFCs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rfcs/approved.html"><strong aria-hidden="true">2.1.</strong> Approved RFCs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rfcs/0001-subgraph-composition.html"><strong aria-hidden="true">2.1.1.</strong> RFC-0001: Subgraph Composition</a></li><li class="chapter-item expanded "><a href="../rfcs/0002-ethereum-tracing-cache.html"><strong aria-hidden="true">2.1.2.</strong> RFC-0002: Ethereum Tracing Cache</a></li><li class="chapter-item expanded "><a href="../rfcs/0003-mutations.html"><strong aria-hidden="true">2.1.3.</strong> RFC-0003: Mutations</a></li><li class="chapter-item expanded "><a href="../rfcs/0004-fulltext-search.html"><strong aria-hidden="true">2.1.4.</strong> RFC-0004: Fulltext Search</a></li></ol></li><li class="chapter-item expanded "><a href="../rfcs/obsolete.html"><strong aria-hidden="true">2.2.</strong> Obsolete RFCs</a></li><li class="chapter-item expanded "><a href="../rfcs/rejected.html"><strong aria-hidden="true">2.3.</strong> Rejected RFCs</a></li></ol></li><li class="chapter-item expanded "><a href="../engineering-plans/index.html"><strong aria-hidden="true">3.</strong> Engineering Plans</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../engineering-plans/approved.html"><strong aria-hidden="true">3.1.</strong> Approved Plans</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../engineering-plans/0001-graphql-query-prefetching.html"><strong aria-hidden="true">3.1.1.</strong> PLAN-0001: GraphQL Query Prefetching</a></li><li class="chapter-item expanded "><a href="../engineering-plans/0002-ethereum-tracing-cache.html"><strong aria-hidden="true">3.1.2.</strong> PLAN-0002: Ethereum Tracing Cache</a></li><li class="chapter-item expanded "><a href="../engineering-plans/0003-remove-jsonb-storage.html" class="active"><strong aria-hidden="true">3.1.3.</strong> PLAN-0003: Remove JSONB Storage</a></li></ol></li><li class="chapter-item expanded "><a href="../engineering-plans/obsolete.html"><strong aria-hidden="true">3.2.</strong> Obsolete Plans</a></li><li class="chapter-item expanded "><a href="../engineering-plans/rejected.html"><strong aria-hidden="true">3.3.</strong> Rejected Plans</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Graph Protocol RFCs and Engineering Plans</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#plan-0003-remove-jsonb-storage" id="plan-0003-remove-jsonb-storage">PLAN-0003: Remove JSONB Storage</a></h1>
<dl>
  <dt>Author</dt>
  <dd>David Lutterkort</dd>
<dt>Implements</dt>
  <dd>No RFC - no user visible changes</dd>
<dt>Engineering Plan pull request</dt>
  <dd><a href="https://github.com/graphprotocol/rfcs/pull/7">https://github.com/graphprotocol/rfcs/pull/7</a></dd>
<dt>Date of submission</dt>
  <dd>2019-12-18</dd>
<dt>Date of approval</dt>
  <dd>2019-12-20</dd>
<dt>Approved by</dt>
  <dd>Jess Ngo, Jannis Pohlmann</dd>
</dl>
<h2><a class="header" href="#summary" id="summary">Summary</a></h2>
<p>Remove JSONB storage from <code>graph-node</code>. That means that we want to remove
the old storage scheme, and only use relational storage going
forward. At a high level, removal has to touch the following areas:</p>
<ul>
<li>user subgraphs in the hosted service</li>
<li>user subgraphs in self-hosted <code>graph-node</code> instances</li>
<li>subgraph metadata in <code>subgraphs.entities</code> (see <a href="https://github.com/graphprotocol/graph-node/issues/1394">this issue</a>)</li>
<li>the <code>graph-node</code> code base</li>
</ul>
<p>Because it touches so many areas and different things, JSONB storage
removal will need to happen in several steps, the last being actual removal
of JSONB code. The first three steps above are independent of each other
and can be done in parallel.</p>
<h2><a class="header" href="#implementation" id="implementation">Implementation</a></h2>
<h3><a class="header" href="#user-subgraphs-in-the-hosted-service" id="user-subgraphs-in-the-hosted-service">User Subgraphs in the Hosted Service</a></h3>
<p>We will need to communicate to users that they need to update their
subgraphs if they still use JSONB storage. Currently, there are ~ 580
subgraphs
(<a href="https://gist.github.com/lutter/2e7a7716b70b4144fe0b6a5f1c9066bc">list</a>)
belonging to 220 different organizations using JSONB storage. It is quite
likely that the vast majority of them is not needed anymore and simply left
over from somebody trying something out.</p>
<p>We should contact users and tell them that we will delete their subgraph
after a certain date (say 2020-02-01) <em>unless</em> they deploy a new version of
the subgraph (with an explanation why etc. of course) Redeploying their
subgraph is all that is needed for those updates.</p>
<h3><a class="header" href="#self-hosted-user-subgraphs" id="self-hosted-user-subgraphs">Self-hosted User Subgraphs</a></h3>
<p>We will need to tell users that the 'old' JSONB storage is deprecated and
support for it will be removed as of some target date, and that they need
to redeploy their subgraph.</p>
<p>Users will need some documentation/tooling to help them understand</p>
<ul>
<li>which of their deployed subgraphs still use JSONB storage</li>
<li>how to remove old subgraphs</li>
<li>how to remove old deployments</li>
</ul>
<h3><a class="header" href="#subgraph-metadata-in-subgraphsentities" id="subgraph-metadata-in-subgraphsentities">Subgraph Metadata in <code>subgraphs.entities</code></a></h3>
<p>We can treat the <code>subgraphs</code> schema like a normal subgraph, with the
exception that some entities must not be versioned. For that, we will need
to adopt code that makes it possible to write entities to the store without
recording their version (or, more generally, so that there will only be one
version of the entity, tagged with a block range <code>[0,)</code>)</p>
<p>We will manually create the DDL for the <code>subgraphs.graphql</code> schema and run
that as part of a database migration. In that migration, we will also copy
the existing metadata from <code>subgraphs.entities</code> and
<code>subgraphs.entity_history</code> into their new tables.</p>
<h3><a class="header" href="#the-code-base" id="the-code-base">The Code Base</a></h3>
<p>Delete all code handling JSONB storage. This will mostly affect
<code>entities.rs</code> and <code>jsonb_queries.rs</code> in <code>graph-store-postgres</code>, but there
are also smaller things like that we do not need the annotations on
<code>Entity</code> to serialize them to the JSON format that JSONB uses.</p>
<h2><a class="header" href="#tests" id="tests">Tests</a></h2>
<p>Most of the code-level changes are covered by the existing test suite. The
major exception is that the migration of subgraph metadata needs to be
tested and checked manually, using a recent dump of the production
database.</p>
<h2><a class="header" href="#migration" id="migration">Migration</a></h2>
<p>See above on migrating data in the <code>subgraphs</code> schema.</p>
<h2><a class="header" href="#documentation" id="documentation">Documentation</a></h2>
<p>No user-facing documentation is needed.</p>
<h2><a class="header" href="#implementation-plan" id="implementation-plan">Implementation Plan</a></h2>
<p><em>No estimates yet as we should first agree on this general course of
action</em></p>
<ul>
<li>Notify hosted users to update their subgraph or have it deleted by date X</li>
<li>Mark JSONB storage as deprecated and announce when it will be removed</li>
<li>Provide tool to ship with <code>graph-node</code> to delete unused deployments and
unneeded subgraphs</li>
<li>Add affordance to not version entities to relational storage code</li>
<li>Write SQL migrations to create new subgraph metadata schema and copy
existing data</li>
<li>Delete old JSONB code</li>
<li>On start of <code>graph-node</code>, add check for any deployments that still use
JSONB storage and log warning messages telling users to redeploy (once
the JSONB code has been deleted, this data can not be accessed any more)</li>
</ul>
<h2><a class="header" href="#open-questions" id="open-questions">Open Questions</a></h2>
<p>None</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../engineering-plans/0002-ethereum-tracing-cache.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../engineering-plans/obsolete.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../engineering-plans/0002-ethereum-tracing-cache.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../engineering-plans/obsolete.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../assets/mermaid.min.js"></script>
        
        <script type="text/javascript" src="../assets/mermaid-init.js"></script>
        

        

    </body>
</html>
